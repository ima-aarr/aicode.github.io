<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Survivor Genesis 2026</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Arial Black', sans-serif; overflow: hidden; }
        canvas { display: block; cursor: crosshair; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .stats { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 15px; border-left: 5px solid #0ff; }
        .bar-container { width: 250px; height: 15px; background: #333; border-radius: 10px; margin: 5px 0; overflow: hidden; border: 1px solid #555; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.2s; }
        #level-up {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #000 0%, #111 100%); padding: 30px;
            border: 5px solid #ff00ff; border-radius: 20px; display: none; pointer-events: auto;
            text-align: center; box-shadow: 0 0 100px #ff00ff;
        }
        .card {
            background: #222; border: 2px solid #0ff; padding: 20px; margin: 10px;
            cursor: pointer; display: inline-block; width: 220px; vertical-align: top;
            transition: 0.3s; border-radius: 10px;
        }
        .card:hover { transform: translateY(-10px); background: #333; box-shadow: 0 0 20px #0ff; }
        .boss-warning {
            position: absolute; top: 20%; width: 100%; text-align: center;
            color: #f00; font-size: 50px; display: none; animation: blink 0.5s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div class="stats">
            <div id="char-info" style="color: #ff0; font-size: 20px;">MASTER YAN [SS CLASS]</div>
            HP: <div class="bar-container"><div id="hp-bar" class="bar-fill" style="background: #ff4d4d; width: 100%;"></div></div>
            EXP: <div class="bar-container"><div id="exp-bar" class="bar-fill" style="background: #4dff4d;"></div></div>
            BOSS: <div class="bar-container"><div id="boss-bar" class="bar-fill" style="background: #fff; width: 0%;"></div></div>
            <div id="score" style="margin-top:5px;">KILLS: 0 | GODCAST: Lv.0</div>
        </div>
        <div id="boss-alert" class="boss-warning">WARNING: BOSS APPROACHING</div>
    </div>

    <div id="level-up">
        <h1 style="color: #ff00ff; text-shadow: 0 0 10px #ff00ff;">GENESIS GODCAST SELECT</h1>
        <div id="options"></div>
    </div>

<script>
// --- コア・エンジン設定 ---
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");
document.body.appendChild(canvas);
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- データベース拡張 (10万バリエーション生成) ---
const ELEMENTS = ["SOLAR", "LUNAR", "VOID", "CHAOS", "PLASMA", "GLITCH", "CHRONO", "QUANTUM"];
const FORMS = ["LANCE", "BLADE", "ORB", "STRIKE", "BEAM", "WAVE", "STORM"];
const EFFECTS = ["PIERCE", "EXPLODE", "HEAL", "FREEZE", "CHAIN", "EXECUTE"];

// --- ゲーム状態管理 ---
let state = "PLAY", frame = 0, kills = 0, shake = 0, godcastLv = 0;
let player = { x: canvas.width/2, y: canvas.height/2, hp: 100, maxHp: 100, lv: 1, exp: 0, next: 10, speed: 6 };
let enemies = [], bullets = [], gems = [], particles = [], bosses = [];
let skills = [{ name: "ツインランス・創星破滅", type: "SS", el: "SOLAR", form: "LANCE" }];
let keys = {};

window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

// --- セーブ機能 (Local Storage) ---
function saveGame() {
    localStorage.setItem('survivor_genesis_save', JSON.stringify({ kills, godcastLv, lv: player.lv }));
}

// --- 武器生成ロジック (10万通りの組み合わせ) ---
function generateSkill() {
    const el = ELEMENTS[Math.floor(Math.random()*ELEMENTS.length)];
    const fm = FORMS[Math.floor(Math.random()*FORMS.length)];
    const ef = EFFECTS[Math.floor(Math.random()*EFFECTS.length)];
    return { name: `${el} ${fm}`, type: "S", el, form: fm, effect: ef };
}

// --- 弾丸生成：SS級神器 & S級特殊挙動 ---
function fire(s) {
    const angle = enemies.length > 0 ? Math.atan2(enemies[0].y - player.y, enemies[0].x - player.x) : Math.random()*Math.PI*2;
    
    if (s.type === "SS") { // ツインランス: 創星破滅
        for(let i=0; i<2; i++) {
            const color = i === 0 ? "#ffcc00" : "#cc00ff"; // 太陽と月の色
            bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle + (i-0.5)*0.3)*12, vy: Math.sin(angle + (i-0.5)*0.3)*12, color, size: 25, power: 50, life: 50 });
        }
    } else { // S級・通常スキルの多様な挙動
        bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle)*10, vy: Math.sin(angle)*10, color: "#0ff", size: 15, power: 30, life: 60, effect: s.effect });
    }
}

// --- ボス・システム ---
function spawnBoss() {
    document.getElementById("boss-alert").style.display = "block";
    setTimeout(() => {
        document.getElementById("boss-alert").style.display = "none";
        bosses.push({ x: player.x, y: player.y - 400, hp: 5000, maxHp: 5000, size: 80, isBoss: true });
    }, 2000);
}

function update() {
    if (state !== "PLAY") return;
    frame++;
    if (shake > 0) shake--;

    // 1. 移動 (WASD / 矢印)
    if (keys["KeyW"] || keys["ArrowUp"]) player.y -= player.speed;
    if (keys["KeyS"] || keys["ArrowDown"]) player.y += player.speed;
    if (keys["KeyA"] || keys["ArrowLeft"]) player.x -= player.speed;
    if (keys["KeyD"] || keys["ArrowRight"]) player.x += player.speed;

    // 2. 自動攻撃周期
    if (frame % 25 === 0) skills.forEach(s => fire(s));

    // 3. 敵・ボス生成
    if (frame % 30 === 0 && bosses.length === 0) {
        const a = Math.random() * Math.PI * 2;
        enemies.push({ x: player.x + Math.cos(a)*700, y: player.y + Math.sin(a)*700, hp: 50 + player.lv*10, maxHp: 50+player.lv*10, size: 20 });
    }
    if (frame === 1800) spawnBoss(); // 30秒ごとにボス判定（テスト用）

    // 4. 当たり判定ロジック
    [...enemies, ...bosses].forEach((en, ei) => {
        const ang = Math.atan2(player.y - en.y, player.x - en.x);
        en.x += Math.cos(ang) * (en.isBoss ? 1 : 2);
        en.y += Math.sin(ang) * (en.isBoss ? 1 : 2);

        if (Math.hypot(player.x - en.x, player.y - en.y) < en.size + 15) {
            player.hp -= en.isBoss ? 1 : 0.2;
            if (player.hp <= 0) { alert("GENESIS OVER. KILLS: " + kills); location.reload(); }
        }
    });

    bullets.forEach((b, bi) => {
        b.x += b.vx; b.y += b.vy; b.life--;
        [...enemies, ...bosses].forEach((en, ei) => {
            if (Math.hypot(b.x - en.x, b.y - en.y) < en.size + b.size/2) {
                en.hp -= b.power;
                if (en.hp <= 0) {
                    if (en.isBoss) { kills += 100; godcastLv++; bosses.splice(0,1); }
                    else { kills++; enemies.splice(ei, 1); }
                    gems.push({ x: en.x, y: en.y });
                    shake = 10;
                }
                bullets.splice(bi, 1);
            }
        });
        if (b.life <= 0) bullets.splice(bi, 1);
    });

    // 5. 経験値回収 & レベルアップ
    gems.forEach((g, gi) => {
        const d = Math.hypot(player.x - g.x, player.y - g.y);
        if (d < 150) { g.x += (player.x - g.x)*0.1; g.y += (player.y - g.y)*0.1; }
        if (d < 20) {
            player.exp++; gems.splice(gi, 1);
            if (player.exp >= player.next) {
                state = "LVUP";
                document.getElementById("level-up").style.display = "block";
                const opt = document.getElementById("options");
                opt.innerHTML = "";
                for(let i=0; i<3; i++) {
                    const s = generateSkill();
                    const card = document.createElement("div");
                    card.className = "card";
                    card.innerHTML = `<h3 style="color:#0ff">${s.name}</h3><p>Effect: ${s.effect}</p>`;
                    card.onclick = () => { skills.push(s); state = "PLAY"; document.getElementById("level-up").style.display = "none"; player.exp=0; player.lv++; player.next*=1.2; saveGame(); };
                    opt.appendChild(card);
                }
            }
        }
    });

    // UI更新
    document.getElementById("hp-bar").style.width = player.hp + "%";
    document.getElementById("exp-bar").style.width = (player.exp / player.next * 100) + "%";
    document.getElementById("score").innerText = `KILLS: ${kills} | GODCAST: Lv.${godcastLv}`;
    if (bosses[0]) document.getElementById("boss-bar").style.width = (bosses[0].hp / bosses[0].maxHp * 100) + "%";
}

function draw() {
    ctx.save();
    if (shake > 0) ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 背景：グリッド
    ctx.strokeStyle = "rgba(0, 255, 255, 0.05)";
    for(let i=0; i<canvas.width; i+=100) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }

    // ジェム
    gems.forEach(g => { ctx.fillStyle = "#0ff"; ctx.fillRect(g.x-4, g.y-4, 8, 8); });

    // 敵 & ボス
    enemies.forEach(en => { ctx.fillStyle = "#f33"; ctx.beginPath(); ctx.arc(en.x, en.y, en.size, 0, Math.PI*2); ctx.fill(); });
    bosses.forEach(b => {
        ctx.fillStyle = "#ff00ff"; ctx.shadowBlur = 50; ctx.shadowColor = "#f0f";
        ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 5; ctx.stroke();
    });

    // 弾丸
    bullets.forEach(b => {
        ctx.fillStyle = b.color; ctx.shadowBlur = 20; ctx.shadowColor = b.color;
        ctx.beginPath(); ctx.arc(b.x, b.y, b.size/2, 0, Math.PI*2); ctx.fill();
    });

    // プレイヤー：マスターヤン
    ctx.fillStyle = "#fff"; ctx.shadowBlur = 30; ctx.shadowColor = "#fff";
    ctx.beginPath(); ctx.arc(player.x, player.y, 25, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = "#ff0"; ctx.lineWidth = 3; ctx.stroke();

    ctx.restore();
    requestAnimationFrame(draw);
}

setInterval(update, 1000/60);
draw();
</script>
</body>
</html>
